worker_processes auto;
pid /tmp/nginx.pid;
user debian;
daemon off;

error_log stderr error;
pcre_jit on;

events {
  worker_connections 1024;
}

http {
    client_max_body_size 1m;
    keepalive_timeout 65;

	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	ssl_prefer_server_ciphers on;
	ssl_session_cache shared:SSL:2m;

	gzip_vary on;

    log_format cache '[$time_local] $remote_addr $upstream_cache_status "$request"';

    # Store max 10GB for 1y of inactive resource
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=cache_zone:100m max_size=10g inactive=1y;

    include /etc/nginx/conf.d/*.conf;

    server {
        resolver 8.8.8.8 ipv6=off;
        listen 8080;

        access_log /dev/stdout cache;

        location / {
            expires max;
            proxy_cache cache_zone;
            proxy_cache_valid 200 302 301 1y;
            proxy_cache_key $scheme://$host$request_uri;
            proxy_pass $scheme://$host$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            add_header X-Cached $upstream_cache_status;
            add_header X-Cache-Server "mendlik/nginx-cache";
            proxy_ignore_headers "Set-Cookie";
        }
    }
}
